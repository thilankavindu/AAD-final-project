<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Management</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .category-card {
            transition: transform 0.3s;
        }
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .category-img {
            height: 200px;
            object-fit: cover;
        }
        .action-buttons .btn {
            margin-right: 5px;
        }
        .preview-image {
            max-height: 150px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="container py-5">
    <h1 class="text-center mb-5">Category Management</h1>

    <div class="d-flex justify-content-between mb-4">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
            <i class="fas fa-plus"></i> Add New Category
        </button>
    </div>

    <!-- Categories Table -->
    <div class="row" id="categoriesContainer">
        <!-- Categories will be loaded here via AJAX -->
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCategoryForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="categoryName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoryDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="categoryDescription" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="categoryImage" class="form-label">Category Image</label>
                            <input type="file" class="form-control" id="categoryImage" name="imageUrl" accept="image/*">
                            <div id="imagePreview" class="text-center mt-2"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save Category</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCategoryForm" enctype="multipart/form-data">
                        <input type="hidden" id="editCategoryId" name="id">
                        <div class="mb-3">
                            <label for="editCategoryName" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="editCategoryName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="editCategoryDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editCategoryDescription" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editCategoryImage" class="form-label">Category Image</label>
                            <input type="file" class="form-control" id="editCategoryImage" name="imageUrl" accept="image/*">
                            <div id="editImagePreview" class="text-center mt-2"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Update Category</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this category?</p>
                    <input type="hidden" id="categoryIdToDelete">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

    const JWT_TOKEN = "eyJhbGciOiJIUzUxMiJ9.eyJyb2xlIjoiQWRtaW4iLCJzdWIiOiJrYXZpbmR1dGhpbGFuNEBnbWFpbC5jb20iLCJpYXQiOjE3NDM0OTM2NTIsImV4cCI6MTc0NDUzMDQ1Mn0.b93eiue4MNODDjhS4ufCjy2xmsmJLhWGB5lM7wX6-0Oxy9fRqyH1PRn1jJJ4g26g2Sprot1R8ujsPJFQIRyuQg";
    $(document).ready(function() {
        // Load categories on page load
        loadCategories();

        // Image preview for add form
        $('#categoryImage').change(function() {
            previewImage(this, '#imagePreview');
        });

        // Image preview for edit form
        $('#editCategoryImage').change(function() {
            previewImage(this, '#editImagePreview');
        });

        // Add category form submission
        $('#addCategoryForm').submit(function(e) {
            e.preventDefault();
            addCategory();
        });

        // Edit category form submission
        $('#editCategoryForm').submit(function(e) {
            e.preventDefault();
            updateCategory();
        });

        // Confirm delete button
        $('#confirmDeleteBtn').click(function() {
            deleteCategory();
        });
    });

    function previewImage(input, previewContainer) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $(previewContainer).html('<img src="' + e.target.result + '" class="img-fluid preview-image">');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function loadCategories() {
        $.ajax({
            url: 'http://localhost:8080/api/categories/getAll',
            type: 'GET',
            headers: {
                Authorization: "Bearer " + JWT_TOKEN,
                'Content-Type': 'application/json'
            },
            success: function(response) {
                displayCategories(response);
            },
            error: function(xhr, status, error) {
                showToast('Error', 'Failed to load categories: ' + error, 'danger');
            }
        });
    }

    function displayCategories(categories) {
        if (categories.length === 0) {
            $('#categoriesContainer').html('<div class="col-12 text-center"><p>No categories found.</p></div>');
            return;
        }

        var html = '';
        categories.forEach(function(category) {
            html += `
                    <div class="col-md-4 mb-4">
                        <div class="card category-card h-100">
                            <img src="${category.imageUrl ? 'http://localhost:8080/uploads/category/' + category.imageUrl : 'https://via.placeholder.com/300x200?text=No+Image'}"
                                 class="card-img-top category-img" alt="${category.name}">
                            <div class="card-body">
                                <h5 class="card-title">${category.name}</h5>
                                <p class="card-text">${category.description || 'No description available'}</p>
                            </div>
                            <div class="card-footer bg-white action-buttons">
                                <button class="btn btn-sm btn-warning edit-category" data-id="${category.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger delete-category" data-id="${category.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
        });

        $('#categoriesContainer').html(html);

        // Attach event handlers to edit buttons
        $('.edit-category').click(function() {
            var categoryId = $(this).data('id');
            loadCategoryForEdit(categoryId);
        });

        // Attach event handlers to delete buttons
        $('.delete-category').click(function() {
            var categoryId = $(this).data('id');
            $('#categoryIdToDelete').val(categoryId);
            $('#confirmDeleteModal').modal('show');
        });
    }

    function loadCategoryForEdit(categoryId) {
        $.ajax({
            url: 'http://localhost:8080/api/categories' + categoryId,
            type: 'GET',
            headers: {
                Authorization: "Bearer " + JWT_TOKEN,
                'Content-Type': 'application/json'
            },
            success: function(category) {
                $('#editCategoryId').val(category.id);
                $('#editCategoryName').val(category.name);
                $('#editCategoryDescription').val(category.description);

                // Display current image if exists
                if (category.imageUrl) {
                    $('#editImagePreview').html(`
                            <p>Current Image:</p>
                            <img src="http://localhost:8080/uploads/category/${category.imageUrl}" class="img-fluid preview-image">
                        `);
                } else {
                    $('#editImagePreview').html('<p>No image currently set</p>');
                }

                $('#editCategoryModal').modal('show');
            },
            error: function(xhr, status, error) {
                showToast('Error', 'Failed to load category: ' + error, 'danger');
            }
        });
    }

    function addCategory() {
        var formData = new FormData($('#addCategoryForm')[0]);

        $.ajax({
            url: 'http://localhost:8080/api/categories/save',
            type: 'POST',
            headers: {
                Authorization: "Bearer " + JWT_TOKEN,
                'Content-Type': 'application/json'
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#addCategoryModal').modal('hide');
                $('#addCategoryForm')[0].reset();
                $('#imagePreview').empty();
                loadCategories();
                showToast('Success', 'Category added successfully!', 'success');
            },
            error: function(xhr, status, error) {
                showToast('Error', 'Failed to add category: ' + error, 'danger');
            }
        });
    }

    function updateCategory() {
        var formData = new FormData($('#editCategoryForm')[0]);
        var categoryId = $('#editCategoryId').val();

        $.ajax({
            url: 'http://localhost:8080/api/categories/update' + categoryId,
            type: 'PUT',
            headers: {
                Authorization: "Bearer " + JWT_TOKEN,
                'Content-Type': 'application/json'
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#editCategoryModal').modal('hide');
                loadCategories();
                showToast('Success', 'Category updated successfully!', 'success');
            },
            error: function(xhr, status, error) {
                showToast('Error', 'Failed to update category: ' + error, 'danger');
            }
        });
    }

    function deleteCategory() {
        var categoryId = $('#categoryIdToDelete').val();

        $.ajax({
            url: 'http://localhost:8080/api/categories/delete' + categoryId,
            type: 'DELETE',
            headers: {
                Authorization: "Bearer " + JWT_TOKEN,
                'Content-Type': 'application/json'
            },
            success: function(response) {
                $('#confirmDeleteModal').modal('hide');
                loadCategories();
                showToast('Success', 'Category deleted successfully!', 'success');
            },
            error: function(xhr, status, error) {
                showToast('Error', 'Failed to delete category: ' + error, 'danger');
            }
        });
    }

    function showToast(title, message, type) {
        var toast = $('#toastNotification');
        var toastTitle = $('#toastTitle');
        var toastMessage = $('#toastMessage');

        // Set title and message
        toastTitle.text(title);
        toastMessage.text(message);

        // Set background color based on type
        toast.removeClass('bg-success bg-danger bg-warning bg-info');
        if (type === 'success') {
            toast.addClass('bg-success text-white');
        } else if (type === 'danger') {
            toast.addClass('bg-danger text-white');
        } else if (type === 'warning') {
            toast.addClass('bg-warning text-dark');
        } else {
            toast.addClass('bg-info text-white');
        }

        // Show the toast
        var bsToast = new bootstrap.Toast(toast[0]);
        bsToast.show();
    }
</script>
</body>
</html>