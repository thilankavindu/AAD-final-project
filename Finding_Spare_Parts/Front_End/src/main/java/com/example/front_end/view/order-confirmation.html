<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Confirmation - Bike Spare Parts</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Navigation Bar Styling */
        .navbar {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 0;
            margin-bottom: 25px;
        }

        .navbar-brand, .nav-link {
            color: white !important;
        }

        .navbar-brand:hover, .nav-link:hover {
            color: #f8f9fa !important;
        }

        .navbar-toggler {
            border-color: rgba(255, 255, 255, 0.5);
        }

        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        .user-dropdown {
            cursor: pointer;
            position: relative;
        }

        .user-dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            min-width: 200px;
            z-index: 1000;
        }

        .user-dropdown-menu.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 10px 15px;
            color: #333;
            text-decoration: none;
            display: block;
            transition: background-color 0.2s;
        }

        .user-dropdown-item:hover {
            background: #f5f5f5;
            color: #0d6efd;
        }

        /* Footer Styling */
        footer {
            background-color: #222;
            color: #fff;
            padding: 40px 0;
            margin-top: 50px;
        }

        .footer-links h5 {
            color: #fff;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .footer-links ul {
            list-style: none;
            padding-left: 0;
        }

        .footer-links li {
            margin-bottom: 10px;
        }

        .footer-links a {
            color: #aaa;
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: #fff;
        }

        .social-links a {
            color: #fff;
            font-size: 1.2rem;
            margin-right: 15px;
            transition: color 0.2s;
        }

        .social-links a:hover {
            color: #0d6efd;
        }

        .copyright {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #444;
            font-size: 0.9rem;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .navbar {
                padding: 10px 0;
            }

            .footer-links {
                margin-bottom: 30px;
            }

            .user-dropdown-menu {
                position: fixed;
                top: auto;
                left: 0;
                right: 0;
                width: 100%;
                border-radius: 0;
                z-index: 1050;
            }

            .user-dropdown-item {
                padding: 15px;
                text-align: center;
            }
        }

        /* Print Styles */
        @media print {
            .navbar, footer {
                display: none !important;
            }

            body {
                padding-top: 0 !important;
            }
        }
        .navbar {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 0;
        }
        .navbar-brand, .nav-link {
            color: white !important;
        }
        .confirmation-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
        }
        .order-success {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        .success-icon {
            color: #28a745;
            font-size: 4rem;
            margin-bottom: 15px;
        }
        .order-details {
            margin-bottom: 30px;
        }
        .order-items {
            margin-bottom: 20px;
        }
        .item-row {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .item-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }
        .address-box, .payment-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .order-summary {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .summary-total {
            font-weight: bold;
            border-top: 1px solid #dee2e6;
            padding-top: 8px;
            margin-top: 8px;
        }
        .actions {
            margin-top: 30px;
            text-align: center;
        }
        footer {
            background-color: #222;
            color: #fff;
            padding: 40px 0;
            margin-top: 50px;
        }
        .footer-links h5 {
            color: #fff;
            margin-bottom: 20px;
        }
        .footer-links ul {
            list-style: none;
            padding-left: 0;
        }
        .footer-links li {
            margin-bottom: 10px;
        }
        .footer-links a {
            color: #aaa;
            text-decoration: none;
        }
        .footer-links a:hover {
            color: #fff;
        }
        .social-links a {
            color: #fff;
            font-size: 1.2rem;
            margin-right: 15px;
        }
        .copyright {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #444;
        }
        #alertSuccess, #alertError {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: none;
        }
        #alertSuccess.show, #alertError.show {
            display: block;
        }
        @media print {
            .navbar, .actions, footer, .no-print {
                display: none !important;
            }
            body {
                background-color: white;
            }
            .confirmation-container {
                box-shadow: none;
                margin: 0;
                padding: 15px 0;
            }
            .print-only {
                display: block !important;
            }
        }
        .print-only {
            display: none;
        }
    </style>
</head>
<body>
<!-- Alert messages -->
<div id="alertSuccess" class="alert alert-success alert-dismissible fade">
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    <span id="successMessage"></span>
</div>
<div id="alertError" class="alert alert-danger alert-dismissible fade">
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    <span id="errorMessage"></span>
</div>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand" href="index.html">
            <i class="fas fa-motorcycle me-2"></i>Bike Spare Parts
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="categories.html">Categories</a></li>
                <li class="nav-item"><a class="nav-link" href="products.html">Products</a></li>
                <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
                <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
            </ul>
            <div class="d-flex align-items-center">
                <a href="shopping-cart.html" class="nav-link me-3">
                    <i class="fas fa-shopping-cart"></i> Cart <span id="cartCount" class="badge bg-danger">0</span>
                </a>
                <!-- Login/Register buttons (shown when not logged in) -->
                <div id="authButtons">
                    <a href="Authentication.html" class="btn btn-outline-light me-2">Login</a>
                    <a href="Authentication.html" class="btn btn-light">Register</a>
                </div>
                <!-- User dropdown (shown when logged in) -->
                <div id="userDropdown" class="user-dropdown d-none">
                    <div class="d-flex align-items-center text-white">
                        <i class="fas fa-user-circle me-2"></i>
                        <span id="userNameDisplay">User</span>
                        <i class="fas fa-chevron-down ms-2"></i>
                    </div>
                    <div class="user-dropdown-menu">
                        <a href="profile.html" class="user-dropdown-item">
                            <i class="fas fa-user me-2"></i> Profile
                        </a>
                        <a href="orders.html" class="user-dropdown-item">
                            <i class="fas fa-shopping-bag me-2"></i> My Orders
                        </a>
                        <a href="#" id="logoutBtn" class="user-dropdown-item">
                            <i class="fas fa-sign-out-alt me-2"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Order Confirmation Content -->
<div class="container my-5">
    <!-- Print header - only shows when printing -->
    <div class="row print-only">
        <div class="col-12 text-center mb-4">
            <h2>Bike Spare Parts</h2>
            <p>123 Bike Street, City, Country</p>
            <p>Order Receipt</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="confirmation-container">
                <!-- Order Success Message -->
                <div class="order-success">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2>Thank You for Your Order!</h2>
                    <p class="lead">Your order has been placed successfully.</p>
                    <p>An email confirmation has been sent to <span id="customerEmail">your email address</span>.</p>
                </div>

                <!-- Order Details -->
                <div class="order-details">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Order Information</h5>
                            <p><strong>Order Number:</strong> <span id="orderNumber">#ORD-12345</span></p>
                            <p><strong>Order Date:</strong> <span id="orderDate">April 14, 2025</span></p>
                            <p><strong>Order Status:</strong> <span id="orderStatus">Processing</span></p>
                        </div>
                        <div class="col-md-6">
                            <h5>Customer Information</h5>
                            <p><strong>Name:</strong> <span id="customerName">John Doe</span></p>
                            <p><strong>Email:</strong> <span id="customerEmailDetails">john.doe@example.com</span></p>
                            <p><strong>Phone:</strong> <span id="customerPhone">+1 234 567 8900</span></p>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <h5>Order Items</h5>
                <div class="order-items" id="orderItems">
                    <!-- Order items will be dynamically added here -->
                </div>

                <!-- Shipping and Payment Info -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h5>Shipping Address</h5>
                        <div class="address-box" id="shippingAddress">
                            <!-- Shipping address will be added here -->
                        </div>
                        <h5>Billing Address</h5>
                        <div class="address-box" id="billingAddress">
                            <!-- Billing address will be added here -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Payment Method</h5>
                        <div class="payment-box" id="paymentMethod">
                            <!-- Payment method info will be added here -->
                        </div>
                        <h5>Order Summary</h5>
                        <div class="order-summary">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="subtotal">$0.00</span>
                            </div>
                            <div class="summary-row">
                                <span>Shipping:</span>
                                <span id="shipping">$0.00</span>
                            </div>
                            <div class="summary-row">
                                <span>Tax:</span>
                                <span id="tax">$0.00</span>
                            </div>
                            <div class="summary-row summary-total">
                                <span>Total:</span>
                                <span id="total">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="actions">
                    <button class="btn btn-primary" id="printReceiptBtn">
                        <i class="fas fa-print me-2"></i> Print Receipt
                    </button>
                    <a href="index.html" class="btn btn-success">
                        <i class="fas fa-shopping-cart me-2"></i> Continue Shopping
                    </a>
                    <a href="orders.html" class="btn btn-outline-secondary">
                        <i class="fas fa-list me-2"></i> View All Orders
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-md-4 footer-links">
                <h5>Quick Links</h5>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="categories.html">Categories</a></li>
                    <li><a href="products.html">Products</a></li>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="contact.html">Contact Us</a></li>
                </ul>
            </div>
            <div class="col-md-4 footer-links">
                <h5>Customer Service</h5>
                <ul>
                    <li><a href="faq.html">FAQ</a></li>
                    <li><a href="shipping.html">Shipping Policy</a></li>
                    <li><a href="returns.html">Returns & Refunds</a></li>
                    <li><a href="terms.html">Terms & Conditions</a></li>
                    <li><a href="privacy.html">Privacy Policy</a></li>
                </ul>
            </div>
            <div class="col-md-4 footer-links">
                <h5>Contact Us</h5>
                <p><i class="fas fa-map-marker-alt me-2"></i> 123 Bike Street, City, Country</p>
                <p><i class="fas fa-phone me-2"></i> +1 234 567 8900</p>
                <p><i class="fas fa-envelope me-2"></i> info@bikespareparts.com</p>
                <div class="social-links mt-3">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin"></i></a>
                </div>
            </div>
        </div>
        <div class="text-center copyright">
            <p>&copy; 2025 Bike Spare Parts. All rights reserved.</p>
        </div>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Configuration constants for URLs
    const API_BASE_URL = "http://localhost:8080";

    // Global variables to track order totals
    let orderTotals = {
        subtotal: 0,
        shipping: 10, // Default shipping cost
        tax: 0,
        total: 0
    };

    $(document).ready(function() {
        // Check if user is logged in
        checkLoginStatus();

        // Get order ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');

        if (orderId) {
            // First load order details, then load order items
            loadOrderDetails(orderId);
        } else {
            showError("No order ID provided. Redirecting to orders page...");
            setTimeout(() => {
                window.location.href = 'orders.html';
            }, 2000);
        }

        // Event handlers
        $('#printReceiptBtn').click(function() {
            window.print();
        });

        setupUserDropdown();
    });

    // Check if user is logged in
    function checkLoginStatus() {
        const token = localStorage.getItem('token');
        const userEmail = localStorage.getItem('userEmail');
        const userRole = localStorage.getItem('role');

        if (token && userEmail) {
            // User is logged in
            $('#authButtons').addClass('d-none');
            $('#userDropdown').removeClass('d-none');
            $('#userNameDisplay').text(userEmail);
            $('#customerEmail').text(userEmail);
            $('#customerEmailDetails').text(userEmail);

            // Add admin dashboard link if admin
            if (userRole === 'Admin') {
                $('.user-dropdown-menu').prepend(`
                    <a href="admin-dashboard.html" class="user-dropdown-item">
                        <i class="fas fa-tachometer-alt me-2"></i> Admin Dashboard
                    </a>
                `);
            }

            // Get cart count
            loadCartCount();
        } else {
            // User is not logged in
            $('#authButtons').removeClass('d-none');
            $('#userDropdown').addClass('d-none');

            // Redirect to login
            showError("Please log in to view your order");
            setTimeout(() => {
                window.location.href = 'Authentication.html?redirect=orders.html';
            }, 2000);
        }
    }

    // Setup user dropdown toggle
    function setupUserDropdown() {
        $('.user-dropdown').click(function(e) {
            e.stopPropagation();
            $(this).find('.user-dropdown-menu').toggleClass('show');
        });

        $(document).click(function() {
            $('.user-dropdown-menu').removeClass('show');
        });

        $('#logoutBtn').click(function(e) {
            e.preventDefault();
            logout();
        });
    }

    // Load cart count
    function loadCartCount() {
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId') || 1;

        if (token) {
            $.ajax({
                url: `${API_BASE_URL}/api/cart/${userId}`,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function(data) {
                    let itemCount = 0;
                    if (data && data.cartItems) {
                        itemCount = data.cartItems.length;
                    }
                    $('#cartCount').text(itemCount);
                },
                error: function(xhr) {
                    console.error('Error loading cart:', xhr);
                }
            });
        }
    }

    // Logout
    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('userEmail');
        localStorage.removeItem('role');
        localStorage.removeItem('userId');
        window.location.href = 'index.html';
    }

    // Load order details
    function loadOrderDetails(orderId) {
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId') || 1;

        if (!token) return;

        $.ajax({
            url: `${API_BASE_URL}/api/orders/${orderId}`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(response) {
                // Check if the data is wrapped in a response object
                const orderData = response.data || response;
                displayOrderDetails(orderData);
                loadOrderItems(orderId);
            },
            error: function(xhr) {
                console.error("Error loading order details:", xhr);
                showError("Failed to load order details. Please try again later.");
            }
        });
    }

    // Display order details
    function displayOrderDetails(order) {
        // Calculate totals for the order since they might not be directly available
        let subtotal = 0, shipping = 10, tax = 0, total = 0;

        // Check if we have any order items to calculate subtotal
        if (order.orderItems && order.orderItems.length > 0) {
            order.orderItems.forEach(item => {
                if (item.product && item.product.price) {
                    subtotal += item.product.price * item.quantity;
                }
            });
        }

        // Default calculations if no data is available
        tax = subtotal * 0.1; // 10% tax
        total = subtotal + shipping + tax;

        // Format date - handle different date formats
        let formattedDate = "Processing";
        if (order.orderDate) {
            const orderDate = new Date(order.orderDate);
            formattedDate = orderDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Set order information
        $('#orderNumber').text(`#ORD-${order.id || 'N/A'}`);
        $('#orderDate').text(formattedDate);
        $('#orderStatus').text(order.status || 'Processing');

        // Set customer name from localStorage or order data if available
        const userEmail = localStorage.getItem('userEmail') || 'customer@example.com';
        const customerName = localStorage.getItem('userName') || userEmail.split('@')[0] || 'Valued Customer';
        $('#customerName').text(customerName);
        $('#customerEmailDetails').text(userEmail);
        $('#customerPhone').text(localStorage.getItem('userPhone') || 'Not provided');

        // Set shipping address - using a default format if data structure is different
        try {
            // Try to get address from order data if available
            if (order.shippingAddress) {
                $('#shippingAddress').html(`
                    ${order.shippingAddress.fullName || customerName}<br>
                    ${order.shippingAddress.addressLine1 || ''}<br>
                    ${order.shippingAddress.addressLine2 ? order.shippingAddress.addressLine2 + '<br>' : ''}
                    ${order.shippingAddress.city || ''}, ${order.shippingAddress.state || ''} ${order.shippingAddress.postalCode || ''}<br>
                    ${order.shippingAddress.country || ''}<br>
                    Phone: ${order.shippingAddress.phoneNumber || 'Not provided'}
                `);
            } else {
                // If no shipping address in order, provide a placeholder
                $('#shippingAddress').html(`
                    ${customerName}<br>
                    Standard Shipping<br>
                    Address details will be available once shipping is processed.
                `);
            }
        } catch (e) {
            console.error("Error displaying shipping address:", e);
            $('#shippingAddress').html('Shipping address information unavailable');
        }

        // Set billing address
        try {
            if (order.billingAddress) {
                $('#billingAddress').html(`
                    ${order.billingAddress.fullName || customerName}<br>
                    ${order.billingAddress.addressLine1 || ''}<br>
                    ${order.billingAddress.addressLine2 ? order.billingAddress.addressLine2 + '<br>' : ''}
                    ${order.billingAddress.city || ''}, ${order.billingAddress.state || ''} ${order.billingAddress.postalCode || ''}<br>
                    ${order.billingAddress.country || ''}<br>
                    Phone: ${order.billingAddress.phoneNumber || 'Not provided'}
                `);
            } else {
                $('#billingAddress').html('Same as shipping address');
            }
        } catch (e) {
            console.error("Error displaying billing address:", e);
            $('#billingAddress').html('Same as shipping address');
        }

        // Set payment method with fallback logic
        try {
            if (order.paymentMethod) {
                let paymentIcon = '';
                const paymentType = order.paymentMethod.type || 'Standard Payment';

                switch (paymentType.toUpperCase()) {
                    case 'CREDIT_CARD':
                        paymentIcon = '<i class="fab fa-cc-visa me-2"></i>';
                        break;
                    case 'PAYPAL':
                        paymentIcon = '<i class="fab fa-paypal me-2"></i>';
                        break;
                    case 'COD':
                        paymentIcon = '<i class="fas fa-money-bill-wave me-2"></i>';
                        break;
                    default:
                        paymentIcon = '<i class="fas fa-credit-card me-2"></i>';
                }

                const cardNumber = order.paymentMethod.cardNumber || '****';
                const cardHolderName = order.paymentMethod.cardHolderName || customerName;

                $('#paymentMethod').html(`
                    ${paymentIcon} ${paymentType}<br>
                    ${cardHolderName ? 'Card Holder: ' + cardHolderName + '<br>' : ''}
                    ${cardNumber ? 'Card: xxxx-xxxx-xxxx-' + cardNumber.slice(-4) : 'Card information secured'}
                `);
            } else {
                $('#paymentMethod').html('<i class="fas fa-credit-card me-2"></i> Standard Payment<br>Payment processed at checkout');
            }
        } catch (e) {
            console.error("Error displaying payment method:", e);
            $('#paymentMethod').html('Payment information not available');
        }

        // Set order totals - use calculated values if not directly available
        $('#subtotal').text(`${(order.subtotal || subtotal).toFixed(2)}`);
        $('#shipping').text(`${(order.shippingCost || shipping).toFixed(2)}`);
        $('#tax').text(`${(order.tax || tax).toFixed(2)}`);
        $('#total').text(`${(order.total || total).toFixed(2)}`);
    }

    // Load order items
    function loadOrderItems(orderId) {
        const token = localStorage.getItem('token');

        if (!token) return;

        $.ajax({
            url: `${API_BASE_URL}/api/order-items/order/${orderId}`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(response) {
                // Check if the data is wrapped in a response object
                const orderItems = response.data || response;

                if (orderItems && orderItems.length > 0) {
                    displayOrderItems(orderItems);
                } else {
                    // Try loading order details again, the items might be nested there
                    $.ajax({
                        url: `${API_BASE_URL}/api/orders/${orderId}`,
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        },
                        success: function(orderResponse) {
                            const orderData = orderResponse.data || orderResponse;
                            if (orderData && orderData.orderItems && orderData.orderItems.length > 0) {
                                displayOrderItems(orderData.orderItems);
                            } else {
                                $('#orderItems').html('<p>No items in this order</p>');
                            }
                        },
                        error: function() {
                            $('#orderItems').html('<p>No items in this order</p>');
                        }
                    });
                }
            },
            error: function(xhr) {
                console.error("Error loading order items:", xhr);
                // Fallback to try another endpoint structure
                $.ajax({
                    url: `${API_BASE_URL}/api/orders/${orderId}/items`,
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    success: function(response) {
                        const orderItems = response.data || response;
                        if (orderItems && orderItems.length > 0) {
                            displayOrderItems(orderItems);
                        } else {
                            $('#orderItems').html('<p>No items in this order</p>');
                        }
                    },
                    error: function() {
                        $('#orderItems').html('<p>Failed to load order items</p>');
                    }
                });
            }
        });
    }

    // Display order items
    function displayOrderItems(orderItems) {
        const orderItemsContainer = $('#orderItems');
        orderItemsContainer.empty();

        // Create a container for items
        const itemsTable = `
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody id="orderItemsTableBody">
                    </tbody>
                </table>
            </div>
        `;

        orderItemsContainer.append(itemsTable);
        const tableBody = $('#orderItemsTableBody');

        // Calculate order totals
        let subtotal = 0;
        let shippingCost = 10; // Default shipping cost
        let tax = 0;
        let totalItems = 0;

        // Check if product information is already embedded in the order items
        const hasEmbeddedProducts = orderItems.some(item => item.product || item.productDetails);

        if (hasEmbeddedProducts) {
            // Products are already embedded in order items
            orderItems.forEach(item => {
                const product = item.product || item.productDetails || {};
                const productName = product.name || 'Product';
                const productPrice = product.price || 0;
                const productImage = product.imageUrl || '';
                const quantity = item.quantity || 1;
                const itemTotal = productPrice * quantity;

                subtotal += itemTotal;
                totalItems += quantity;

                tableBody.append(`
                    <tr>
                        <td>
                            <img src="uploads/product/${productImage}" alt="${productName}" class="item-image"
                                onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60?text=${productName}';">
                        </td>
                        <td>${productName}</td>
                        <td>${productPrice.toFixed(2)}</td>
                        <td>${quantity}</td>
                        <td class="text-end">${itemTotal.toFixed(2)}</td>
                    </tr>
                `);
            });

            // Update order summary
            tax = subtotal * 0.1; // 10% tax
            updateOrderSummary(subtotal, shippingCost, tax);
        } else {
            // Need to fetch product details separately
            const productPromises = orderItems.map(item => {
                return $.ajax({
                    url: `${API_BASE_URL}/api/v1/product/${item.productId}`,
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                }).then(productResponse => {
                    // Handle different response formats
                    const product = productResponse.data || productResponse;

                    if (!product || !product.name) {
                        console.error("Invalid product data:", product);
                        return; // Skip this item
                    }

                    const itemTotal = product.price * item.quantity;
                    subtotal += itemTotal;
                    totalItems += item.quantity;

                    tableBody.append(`
                        <tr>
                            <td>
                                <img src="uploads/product/${product.imageUrl}" alt="${product.name}" class="item-image"
                                    onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60?text=${product.name}';">
                            </td>
                            <td>${product.name}</td>
                            <td>${product.price.toFixed(2)}</td>
                            <td>${item.quantity}</td>
                            <td class="text-end">${itemTotal.toFixed(2)}</td>
                        </tr>
                    `);
                }).catch(error => {
                    console.error("Error fetching product details for item:", item, error);
                    // Add a row with just the item info we have
                    tableBody.append(`
                        <tr>
                            <td><div class="item-image bg-light d-flex align-items-center justify-content-center">?</div></td>
                            <td>Product #${item.productId}</td>
                            <td>--</td>
                            <td>${item.quantity}</td>
                            <td class="text-end">--</td>
                        </tr>
                    `);
                });
            });

            Promise.all(productPromises)
                .then(() => {
                    // Update order summary after all products are loaded
                    tax = subtotal * 0.1; // 10% tax
                    updateOrderSummary(subtotal, shippingCost, tax);
                })
                .catch(error => {
                    console.error("Error fetching product details:", error);
                });
        }
    }

    // Update order summary section
    function updateOrderSummary(subtotal, shipping, tax) {
        const total = subtotal + shipping + tax;

        $('#subtotal').text(`${subtotal.toFixed(2)}`);
        $('#shipping').text(`${shipping.toFixed(2)}`);
        $('#tax').text(`${tax.toFixed(2)}`);
        $('#total').text(`${total.toFixed(2)}`);
    }

    // Show success message
    function showSuccess(message) {
        $("#successMessage").text(message);
        $("#alertSuccess").addClass("show");
        setTimeout(() => $("#alertSuccess").removeClass("show"), 3000);
    }

    // Show error message
    function showError(message) {
        $("#errorMessage").text(message);
        $("#alertError").addClass("show");
        setTimeout(() => $("#alertError").removeClass("show"), 3000);
    }

    // Add this function to handle currency formatting consistently
    function formatCurrency(amount) {
        // Ensure we're working with a number and handle potential NaN
        const value = parseFloat(amount);
        return isNaN(value) ? '$0.00' : '$' + value.toFixed(2);
    }

    // Update the displayOrderDetails function
    function displayOrderDetails(order) {
        // Try to extract order totals if available in the API response
        if (order.subtotal) orderTotals.subtotal = parseFloat(order.subtotal);
        if (order.shippingCost) orderTotals.shipping = parseFloat(order.shippingCost);
        if (order.tax) orderTotals.tax = parseFloat(order.tax);
        if (order.total) orderTotals.total = parseFloat(order.total);

        console.log("Order data received:", order); // Debug log to see data structure

        // Format date - handle different date formats
        let formattedDate = "Processing";
        if (order.orderDate) {
            const orderDate = new Date(order.orderDate);
            formattedDate = orderDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Set order information
        $('#orderNumber').text(`#ORD-${order.id || 'N/A'}`);
        $('#orderDate').text(formattedDate);
        $('#orderStatus').text(order.status || 'Processing');

        // Set customer name from localStorage or order data if available
        const userEmail = localStorage.getItem('userEmail') || 'customer@example.com';
        const customerName = localStorage.getItem('userName') || userEmail.split('@')[0] || 'Valued Customer';
        $('#customerName').text(customerName);
        $('#customerEmailDetails').text(userEmail);
        $('#customerPhone').text(localStorage.getItem('userPhone') || 'Not provided');

        // Display shipping address
        displayShippingAddress(order, customerName);

        // Display billing address
        displayBillingAddress(order, customerName);

        // Display payment method
        displayPaymentMethod(order, customerName);

        // Update order summary with what we know so far
        updateOrderSummary();
    }

    // Helper function to display shipping address
    function displayShippingAddress(order, customerName) {
        try {
            if (order.shippingAddress) {
                $('#shippingAddress').html(`
                ${order.shippingAddress.fullName || customerName}<br>
                ${order.shippingAddress.addressLine1 || ''}<br>
                ${order.shippingAddress.addressLine2 ? order.shippingAddress.addressLine2 + '<br>' : ''}
                ${order.shippingAddress.city || ''}, ${order.shippingAddress.state || ''} ${order.shippingAddress.postalCode || ''}<br>
                ${order.shippingAddress.country || ''}<br>
                Phone: ${order.shippingAddress.phoneNumber || 'Not provided'}
            `);
            } else {
                $('#shippingAddress').html(`
                ${customerName}<br>
                Standard Shipping<br>
                Address details will be available once shipping is processed.
            `);
            }
        } catch (e) {
            console.error("Error displaying shipping address:", e);
            $('#shippingAddress').html('Shipping address information unavailable');
        }
    }

    // Helper function to display billing address
    function displayBillingAddress(order, customerName) {
        try {
            if (order.billingAddress) {
                $('#billingAddress').html(`
                ${order.billingAddress.fullName || customerName}<br>
                ${order.billingAddress.addressLine1 || ''}<br>
                ${order.billingAddress.addressLine2 ? order.billingAddress.addressLine2 + '<br>' : ''}
                ${order.billingAddress.city || ''}, ${order.billingAddress.state || ''} ${order.billingAddress.postalCode || ''}<br>
                ${order.billingAddress.country || ''}<br>
                Phone: ${order.billingAddress.phoneNumber || 'Not provided'}
            `);
            } else {
                $('#billingAddress').html('Same as shipping address');
            }
        } catch (e) {
            console.error("Error displaying billing address:", e);
            $('#billingAddress').html('Same as shipping address');
        }
    }

    // Helper function to display payment method
    function displayPaymentMethod(order, customerName) {
        try {
            if (order.paymentMethod) {
                let paymentIcon = '';
                const paymentType = order.paymentMethod.type || 'Standard Payment';

                switch (paymentType.toUpperCase()) {
                    case 'CREDIT_CARD':
                        paymentIcon = '<i class="fab fa-cc-visa me-2"></i>';
                        break;
                    case 'PAYPAL':
                        paymentIcon = '<i class="fab fa-paypal me-2"></i>';
                        break;
                    case 'COD':
                        paymentIcon = '<i class="fas fa-money-bill-wave me-2"></i>';
                        break;
                    default:
                        paymentIcon = '<i class="fas fa-credit-card me-2"></i>';
                }

                const cardNumber = order.paymentMethod.cardNumber || '****';
                const cardHolderName = order.paymentMethod.cardHolderName || customerName;

                $('#paymentMethod').html(`
                ${paymentIcon} ${paymentType}<br>
                ${cardHolderName ? 'Card Holder: ' + cardHolderName + '<br>' : ''}
                ${cardNumber ? 'Card: xxxx-xxxx-xxxx-' + cardNumber.slice(-4) : 'Card information secured'}
            `);
            } else {
                $('#paymentMethod').html('<i class="fas fa-credit-card me-2"></i> Standard Payment<br>Payment processed at checkout');
            }
        } catch (e) {
            console.error("Error displaying payment method:", e);
            $('#paymentMethod').html('Payment information not available');
        }
    }

    // Improved load order items function
    function loadOrderItems(orderId) {
        const token = localStorage.getItem('token');

        if (!token) return;

        $.ajax({
            url: `${API_BASE_URL}/api/order-items/order/${orderId}`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(response) {
                console.log("Order items API response:", response); // Debug log

                // Check if the data is wrapped in a response object
                const orderItems = response.data || response;

                if (orderItems && orderItems.length > 0) {
                    displayOrderItems(orderItems);
                } else {
                    // Try alternate endpoint
                    fetchOrderItemsAlternate(orderId, token);
                }
            },
            error: function(xhr) {
                console.error("Error loading order items:", xhr);
                fetchOrderItemsAlternate(orderId, token);
            }
        });
    }

    // Helper function to try alternate methods of getting order items
    function fetchOrderItemsAlternate(orderId, token) {
        // First try to get full order with nested items
        $.ajax({
            url: `${API_BASE_URL}/api/orders/${orderId}`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(orderResponse) {
                console.log("Full order data for items:", orderResponse); // Debug log

                const orderData = orderResponse.data || orderResponse;
                if (orderData && orderData.orderItems && orderData.orderItems.length > 0) {
                    displayOrderItems(orderData.orderItems);
                } else {
                    // Try a different endpoint format
                    $.ajax({
                        url: `${API_BASE_URL}/api/orders/${orderId}/items`,
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        },
                        success: function(response) {
                            const alternateItems = response.data || response;
                            if (alternateItems && alternateItems.length > 0) {
                                displayOrderItems(alternateItems);
                            } else {
                                $('#orderItems').html('<p>No items found in this order</p>');
                            }
                        },
                        error: function() {
                            $('#orderItems').html('<p>Could not retrieve order items</p>');
                        }
                    });
                }
            },
            error: function() {
                $('#orderItems').html('<p>Failed to load order items</p>');
            }
        });
    }

    // Improved display order items function
    function displayOrderItems(orderItems) {
        const orderItemsContainer = $('#orderItems');
        orderItemsContainer.empty();

        // Create a container for items
        const itemsTable = `
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th class="text-end">Total</th>
                    </tr>
                </thead>
                <tbody id="orderItemsTableBody">
                </tbody>
            </table>
        </div>
    `;

        orderItemsContainer.append(itemsTable);
        const tableBody = $('#orderItemsTableBody');

        // If we haven't calculated subtotal from order details, do it from the items
        let calculatingSubtotal = (orderTotals.subtotal === 0);
        let subtotalFromItems = 0;
        let totalItems = 0;

        // Check if product information is already embedded in the order items
        const hasEmbeddedProducts = orderItems.some(item => item.product || item.productDetails);

        if (hasEmbeddedProducts) {
            // Products are already embedded in order items
            processEmbeddedProducts(orderItems, tableBody, calculatingSubtotal);
        } else {
            // Need to fetch product details separately
            processItemsWithSeparateProducts(orderItems, tableBody, calculatingSubtotal);
        }
    }

    // Helper function to process items with embedded products
    function processEmbeddedProducts(orderItems, tableBody, calculatingSubtotal) {
        let subtotalFromItems = 0;
        let totalItems = 0;

        orderItems.forEach(item => {
            const product = item.product || item.productDetails || {};
            const productName = product.name || `Product #${item.productId || 'Unknown'}`;
            const productPrice = parseFloat(product.price) || 0;
            const productImage = product.imageUrl || '';
            const quantity = parseInt(item.quantity) || 1;
            const itemTotal = productPrice * quantity;

            if (calculatingSubtotal) {
                subtotalFromItems += itemTotal;
            }
            totalItems += quantity;

            tableBody.append(`
            <tr>
                <td>
                    <img src="uploads/product/${productImage}" alt="${productName}" class="item-image"
                        onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60?text=${productName}';">
                </td>
                <td>${productName}</td>
                <td>${formatCurrency(productPrice)}</td>
                <td>${quantity}</td>
                <td class="text-end">${formatCurrency(itemTotal)}</td>
            </tr>
        `);
        });

        // Update order totals if we calculated from items
        if (calculatingSubtotal && subtotalFromItems > 0) {
            orderTotals.subtotal = subtotalFromItems;
            orderTotals.tax = subtotalFromItems * 0.1; // 10% tax
            orderTotals.total = subtotalFromItems + orderTotals.shipping + orderTotals.tax;
        }

        // Update order summary
        updateOrderSummary();
    }

    // Helper function to process items that need separate product data fetching
    function processItemsWithSeparateProducts(orderItems, tableBody, calculatingSubtotal) {
        let completedItems = 0;
        let subtotalFromItems = 0;
        let totalItems = 0;
        const totalItemsToProcess = orderItems.length;

        orderItems.forEach(item => {
            $.ajax({
                url: `${API_BASE_URL}/api/v1/product/${item.productId}`,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                },
                success: function(productResponse) {
                    // Handle different response formats
                    const product = productResponse.data || productResponse;

                    const productName = product ? product.name : `Product #${item.productId}`;
                    const productPrice = product ? parseFloat(product.price) : 0;
                    const productImage = product ? product.imageUrl : '';
                    const quantity = parseInt(item.quantity) || 1;
                    const itemTotal = productPrice * quantity;

                    if (calculatingSubtotal) {
                        subtotalFromItems += itemTotal;
                    }
                    totalItems += quantity;

                    tableBody.append(`
                    <tr>
                        <td>
                            <img src="uploads/product/${productImage}" alt="${productName}" class="item-image"
                                onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60?text=${productName}';">
                        </td>
                        <td>${productName}</td>
                        <td>${formatCurrency(productPrice)}</td>
                        <td>${quantity}</td>
                        <td class="text-end">${formatCurrency(itemTotal)}</td>
                    </tr>
                `);

                    completedItems++;

                    // If this is the last item, update the summary
                    if (completedItems === totalItemsToProcess) {
                        // Update order totals if we calculated from items
                        if (calculatingSubtotal && subtotalFromItems > 0) {
                            orderTotals.subtotal = subtotalFromItems;
                            orderTotals.tax = subtotalFromItems * 0.1; // 10% tax
                            orderTotals.total = subtotalFromItems + orderTotals.shipping + orderTotals.tax;
                        }

                        // Update order summary
                        updateOrderSummary();
                    }
                },
                error: function() {
                    // Handle error case for this product
                    tableBody.append(`
                    <tr>
                        <td><div class="item-image bg-light d-flex align-items-center justify-content-center">?</div></td>
                        <td>Product #${item.productId}</td>
                        <td>--</td>
                        <td>${item.quantity || 1}</td>
                        <td class="text-end">--</td>
                    </tr>
                `);

                    completedItems++;

                    // If this is the last item, update the summary even with errors
                    if (completedItems === totalItemsToProcess) {
                        updateOrderSummary();
                    }
                }
            });
        });
    }

    // Updated order summary section
    function updateOrderSummary() {
        // Ensure we have valid numbers
        const subtotal = isNaN(orderTotals.subtotal) ? 0 : orderTotals.subtotal;
        const shipping = isNaN(orderTotals.shipping) ? 10 : orderTotals.shipping;
        const tax = isNaN(orderTotals.tax) ? 0 : orderTotals.tax;
        const total = isNaN(orderTotals.total) ? (subtotal + shipping + tax) : orderTotals.total;

        // Format to 2 decimal places with dollar sign
        $('#subtotal').text(formatCurrency(subtotal));
        $('#shipping').text(formatCurrency(shipping));
        $('#tax').text(formatCurrency(tax));
        $('#total').text(formatCurrency(total));

        console.log("Order totals updated:", {subtotal, shipping, tax, total});
    }

    // Load order details with better error handling
    function loadOrderDetails(orderId) {
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId') || 1;

        if (!token) return;

        // Show loading indicator
        $('#orderItems').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading order details...</div>');

        $.ajax({
            url: `${API_BASE_URL}/api/orders/${orderId}`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(response) {
                console.log("Order API response:", response);

                // Check if the data is wrapped in a response object
                const orderData = response.data || response;

                if (orderData) {
                    displayOrderDetails(orderData);

                    // If order has items, display them directly
                    if (orderData.orderItems && orderData.orderItems.length > 0) {
                        displayOrderItems(orderData.orderItems);
                    } else {
                        // Otherwise try to load items separately
                        loadOrderItems(orderId);
                    }
                } else {
                    showError("No order data found. Please try again later.");
                }
            },
            error: function(xhr) {
                console.error("Error loading order details:", xhr);

                // Try alternative approach - load order items directly
                loadOrderItems(orderId);

                // Display placeholder order info
                displayPlaceholderOrderInfo(orderId);

                showError("There was an issue loading your complete order details. Showing available information.");
            }
        });
    }

    // Display placeholder order information when main order details fail to load
    function displayPlaceholderOrderInfo(orderId) {
        $('#orderNumber').text(`#ORD-${orderId}`);
        $('#orderDate').text(new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }));
        $('#orderStatus').text('Processing');

        const userEmail = localStorage.getItem('userEmail') || 'customer@example.com';
        const customerName = localStorage.getItem('userName') || userEmail.split('@')[0] || 'Valued Customer';
        $('#customerName').text(customerName);
        $('#customerEmailDetails').text(userEmail);
        $('#customerPhone').text(localStorage.getItem('userPhone') || 'Not provided');

        // Basic placeholder for addresses and payment
        $('#shippingAddress').html(`
        ${customerName}<br>
        Standard Shipping<br>
        Address details will be available once order processing is complete.
    `);

        $('#billingAddress').html('Same as shipping address');

        $('#paymentMethod').html('<i class="fas fa-credit-card me-2"></i> Standard Payment<br>Payment processed at checkout');
    }

    // Update currency formatting in all display functions
    function updateOrderSummary() {
        // Ensure we have valid numbers
        const subtotal = isNaN(orderTotals.subtotal) ? 0 : orderTotals.subtotal;
        const shipping = isNaN(orderTotals.shipping) ? 10 : orderTotals.shipping;
        const tax = isNaN(orderTotals.tax) ? 0 : orderTotals.tax;
        const total = isNaN(orderTotals.total) ? (subtotal + shipping + tax) : orderTotals.total;

        // Format to 2 decimal places with dollar sign
        $('#subtotal').text(`$${subtotal.toFixed(2)}`);
        $('#shipping').text(`$${shipping.toFixed(2)}`);
        $('#tax').text(`$${tax.toFixed(2)}`);
        $('#total').text(`$${total.toFixed(2)}`);

        console.log("Order totals updated:", {subtotal, shipping, tax, total});
    }

    tableBody.append(`
    <tr>
        <td>
            <img src="uploads/product/${productImage}" alt="${productName}" class="item-image"
                onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60?text=${productName}';">
        </td>
        <td>${productName}</td>
        <td>$${productPrice.toFixed(2)}</td>
        <td>${quantity}</td>
        <td class="text-end">$${itemTotal.toFixed(2)}</td>
    </tr>
`);
</script>
</body>
</html>