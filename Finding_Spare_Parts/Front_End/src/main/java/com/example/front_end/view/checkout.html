<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Bike Spare Parts</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Navigation Bar Styling */
        .navbar {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 0;
            margin-bottom: 25px;
        }

        .navbar-brand, .nav-link {
            color: white !important;
        }

        .navbar-brand:hover, .nav-link:hover {
            color: #f8f9fa !important;
        }

        .navbar-toggler {
            border-color: rgba(255, 255, 255, 0.5);
        }

        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        .user-dropdown {
            cursor: pointer;
            position: relative;
        }

        .user-dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            min-width: 200px;
            z-index: 1000;
        }

        .user-dropdown-menu.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 10px 15px;
            color: #333;
            text-decoration: none;
            display: block;
            transition: background-color 0.2s;
        }

        .user-dropdown-item:hover {
            background: #f5f5f5;
            color: #0d6efd;
        }

        /* Footer Styling */
        footer {
            background-color: #222;
            color: #fff;
            padding: 40px 0;
            margin-top: 50px;
        }

        .footer-links h5 {
            color: #fff;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .footer-links ul {
            list-style: none;
            padding-left: 0;
        }

        .footer-links li {
            margin-bottom: 10px;
        }

        .footer-links a {
            color: #aaa;
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: #fff;
        }

        .social-links a {
            color: #fff;
            font-size: 1.2rem;
            margin-right: 15px;
            transition: color 0.2s;
        }

        .social-links a:hover {
            color: #0d6efd;
        }

        .copyright {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #444;
            font-size: 0.9rem;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .navbar {
                padding: 10px 0;
            }

            .footer-links {
                margin-bottom: 30px;
            }

            .user-dropdown-menu {
                position: fixed;
                top: auto;
                left: 0;
                right: 0;
                width: 100%;
                border-radius: 0;
                z-index: 1050;
            }

            .user-dropdown-item {
                padding: 15px;
                text-align: center;
            }
        }

        /* Print Styles */
        @media print {
            .navbar, footer {
                display: none !important;
            }

            body {
                padding-top: 0 !important;
            }
        }
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 0;
        }

        .checkout-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
        }

        .checkout-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .checkout-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e9ecef;
            z-index: 1;
        }

        .step {
            position: relative;
            z-index: 2;
            background-color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e9ecef;
        }

        .step.active {
            border-color: #3f51b5;
            color: #3f51b5;
        }

        .step.completed {
            border-color: #28a745;
            background-color: #28a745;
            color: white;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 10px;
        }

        .order-summary {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .order-total {
            font-weight: 600;
            border-top: 1px solid #dee2e6;
            margin-top: 15px;
            padding-top: 15px;
        }

        .payment-methods {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .payment-method {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            width: 100px;
        }

        .payment-method.selected {
            border-color: #3f51b5;
            background-color: #f0f2ff;
        }

        .payment-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        #alertSuccess, #alertError {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: none;
        }

        #alertSuccess.show, #alertError.show {
            display: block;
        }
    </style>
</head>
<body>
<!-- Alert messages -->
<div id="alertSuccess" class="alert alert-success alert-dismissible fade">
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    <span id="successMessage"></span>
</div>
<div id="alertError" class="alert alert-danger alert-dismissible fade">
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    <span id="errorMessage"></span>
</div>

<!-- Navigation Bar - Same as your other pages -->
<nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand" href="index.html">
            <i class="fas fa-motorcycle me-2"></i>Bike Spare Parts
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="categories.html">Categories</a></li>
                <li class="nav-item"><a class="nav-link" href="products.html">Products</a></li>
                <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
                <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
            </ul>
            <div class="d-flex align-items-center">
                <a href="cart.html" class="nav-link me-3">
                    <i class="fas fa-shopping-cart"></i> Cart <span id="cartCount" class="badge bg-danger">0</span>
                </a>
                <!-- Login/Register buttons (shown when not logged in) -->
                <div id="authButtons">
                    <a href="Authentication.html" class="btn btn-outline-light me-2">Login</a>
                    <a href="Authentication.html" class="btn btn-light">Register</a>
                </div>
                <!-- User dropdown (shown when logged in) -->
                <div id="userDropdown" class="user-dropdown d-none">
                    <div class="d-flex align-items-center text-white">
                        <i class="fas fa-user-circle me-2"></i>
                        <span id="userNameDisplay">User</span>
                        <i class="fas fa-chevron-down ms-2"></i>
                    </div>
                    <div class="user-dropdown-menu">
                        <a href="profile.html" class="user-dropdown-item">
                            <i class="fas fa-user me-2"></i> Profile
                        </a>
                        <a href="orders.html" class="user-dropdown-item">
                            <i class="fas fa-shopping-bag me-2"></i> My Orders
                        </a>
                        <a href="#" id="logoutBtn" class="user-dropdown-item">
                            <i class="fas fa-sign-out-alt me-2"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>


<div class="container my-5">
    <h2 class="mb-4">Checkout</h2>

    <!-- Checkout Steps -->
    <div class="checkout-steps mb-4">
        <div class="step step-1 active">1</div>
        <div class="step step-2">2</div>
        <div class="step step-3">3</div>
        <div class="step step-4">4</div>
    </div>

    <div class="row">
        <!-- Checkout Forms -->
        <div class="col-md-8">
            <div class="checkout-container">
                <!-- Step 1: Shipping Address -->
                <div class="step-content step-1-content active">
                    <h4 class="section-title">Shipping Address</h4>

                    <!-- Saved Addresses (if any) -->
                    <div id="savedShippingAddresses" class="mb-4">
                        <!-- Will be populated dynamically -->
                    </div>

                    <form id="shippingAddressForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="shippingFullName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="shippingFullName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="shippingPhone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="shippingPhone" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="shippingAddress1" class="form-label">Address Line 1</label>
                            <input type="text" class="form-control" id="shippingAddress1" required>
                        </div>
                        <div class="mb-3">
                            <label for="shippingAddress2" class="form-label">Address Line 2 (Optional)</label>
                            <input type="text" class="form-control" id="shippingAddress2">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="shippingCity" class="form-label">City</label>
                                <input type="text" class="form-control" id="shippingCity" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="shippingState" class="form-label">State/Province</label>
                                <input type="text" class="form-control" id="shippingState" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="shippingPostalCode" class="form-label">Postal Code</label>
                                <input type="text" class="form-control" id="shippingPostalCode" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="shippingCountry" class="form-label">Country</label>
                                <select class="form-select" id="shippingCountry" required>
                                    <option value="">Select Country</option>
                                    <option value="US">United States</option>
                                    <option value="CA">Canada</option>
                                    <option value="UK">United Kingdom</option>
                                    <!-- More countries -->
                                </select>
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="saveShippingAddress">
                            <label class="form-check-label" for="saveShippingAddress">
                                Save this address for future orders
                            </label>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-primary" id="shippingNextBtn">Continue to Billing</button>
                        </div>
                    </form>
                </div>

                <!-- Step 2: Billing Address -->
                <div class="step-content step-2-content">
                    <h4 class="section-title">Billing Address</h4>

                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="sameAsShipping" checked>
                        <label class="form-check-label" for="sameAsShipping">
                            Same as shipping address
                        </label>
                    </div>

                    <!-- Billing form fields (initially hidden) -->
                    <div id="billingAddressForm" style="display: none;">
                        <!-- Similar to shipping address form -->
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary" id="billingBackBtn">Back</button>
                        <button type="button" class="btn btn-primary" id="billingNextBtn">Continue to Payment</button>
                    </div>
                </div>

                <!-- Step 3: Payment Method -->
                <div class="step-content step-3-content">
                    <h4 class="section-title">Payment Method</h4>

                    <div class="payment-methods mb-4">
                        <div class="payment-method selected" data-method="credit-card">
                            <i class="fab fa-cc-visa payment-icon"></i>
                            <div>Credit Card</div>
                        </div>
                        <div class="payment-method" data-method="paypal">
                            <i class="fab fa-paypal payment-icon"></i>
                            <div>PayPal</div>
                        </div>
                        <div class="payment-method" data-method="cash">
                            <i class="fas fa-money-bill-wave payment-icon"></i>
                            <div>Cash on Delivery</div>
                        </div>
                    </div>

                    <!-- Credit Card Form -->
                    <div id="creditCardForm">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="cardNumber" class="form-label">Card Number</label>
                                <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cardName" class="form-label">Name on Card</label>
                                <input type="text" class="form-control" id="cardName" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="cardExpiry" class="form-label">Expiration</label>
                                <input type="text" class="form-control" id="cardExpiry" placeholder="MM/YY" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="cardCvv" class="form-label">CVV</label>
                                <input type="text" class="form-control" id="cardCvv" required>
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="savePaymentMethod">
                            <label class="form-check-label" for="savePaymentMethod">
                                Save this payment method for future orders
                            </label>
                        </div>
                    </div>

                    <!-- PayPal Form (hidden initially) -->
                    <div id="paypalForm" style="display: none;">
                        <p>You will be redirected to PayPal to complete your payment after review.</p>
                    </div>

                    <!-- Cash on Delivery (hidden initially) -->
                    <div id="cashForm" style="display: none;">
                        <p>You will pay in cash when your order is delivered.</p>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary" id="paymentBackBtn">Back</button>
                        <button type="button" class="btn btn-primary" id="paymentNextBtn">Review Order</button>
                    </div>
                </div>

                <!-- Step 4: Review Order -->
                <div class="step-content step-4-content">
                    <h4 class="section-title">Review Your Order</h4>

                    <div class="mb-4">
                        <h5>Shipping Address</h5>
                        <p id="reviewShippingAddress"></p>
                    </div>

                    <div class="mb-4">
                        <h5>Billing Address</h5>
                        <p id="reviewBillingAddress"></p>
                    </div>

                    <div class="mb-4">
                        <h5>Payment Method</h5>
                        <p id="reviewPaymentMethod"></p>
                    </div>

                    <div class="mb-4">
                        <h5>Order Items</h5>
                        <div id="reviewOrderItems"></div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary" id="reviewBackBtn">Back</button>
                        <button type="button" class="btn btn-success" id="placeOrderBtn">Place Order</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-md-4">
            <div class="checkout-container order-summary">
                <h4 class="section-title">Order Summary</h4>

                <div id="orderItems">
                    <!-- Will be populated dynamically -->
                </div>

                <div class="order-item">
                    <span>Subtotal</span>
                    <span id="subtotal">$0.00</span>
                </div>
                <div class="order-item">
                    <span>Shipping</span>
                    <span id="shipping">$0.00</span>
                </div>
                <div class="order-item">
                    <span>Tax</span>
                    <span id="tax">$0.00</span>
                </div>
                <div class="order-item order-total">
                    <span>Total</span>
                    <span id="total">$0.00</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer - Same as your other pages -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-md-4 footer-links">
                <h5>Quick Links</h5>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="categories.html">Categories</a></li>
                    <li><a href="products.html">Products</a></li>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="contact.html">Contact Us</a></li>
                </ul>
            </div>
            <div class="col-md-4 footer-links">
                <h5>Customer Service</h5>
                <ul>
                    <li><a href="faq.html">FAQ</a></li>
                    <li><a href="shipping.html">Shipping Policy</a></li>
                    <li><a href="returns.html">Returns & Refunds</a></li>
                    <li><a href="terms.html">Terms & Conditions</a></li>
                    <li><a href="privacy.html">Privacy Policy</a></li>
                </ul>
            </div>
            <div class="col-md-4 footer-links">
                <h5>Contact Us</h5>
                <p><i class="fas fa-map-marker-alt me-2"></i> 123 Bike Street, City, Country</p>
                <p><i class="fas fa-phone me-2"></i> +1 234 567 8900</p>
                <p><i class="fas fa-envelope me-2"></i> info@bikespareparts.com</p>
                <div class="social-links mt-3">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin"></i></a>
                </div>
            </div>
        </div>
        <div class="text-center copyright">
            <p>&copy; 2025 Bike Spare Parts. All rights reserved.</p>
        </div>
    </div>
</footer>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Configuration constants for URLs
    const API_BASE_URL = "http://localhost:8080";

    // Global variables
    let cartItems = [];
    let products = {};
    let cartTotal = {
        subtotal: 0,
        shipping: 10, // Fixed shipping cost
        tax: 0,
        total: 0
    };
    let selectedPaymentMethod = 'credit-card';

    $(document).ready(function() {
        // Check if user is logged in
        checkLoginStatus();

        // Load cart data
        loadCartData();

        // Load saved addresses if logged in
        loadSavedAddresses();

        // Set up event handlers
        setupEventHandlers();
    });

    // Check if user is logged in
    function checkLoginStatus() {
        const token = localStorage.getItem('token');

        if (!token) {
            // Redirect to login if not logged in
            showError("Please log in to proceed with checkout");
            setTimeout(() => {
                window.location.href = 'Authentication.html?redirect=checkout.html';
            }, 2000);
        }
    }

    // Load cart data
    function loadCartData() {
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId') || 1;

        if (!token) return;

        $.ajax({
            url: `${API_BASE_URL}/api/cart/${userId}`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(cartData) {
                if (cartData && cartData.cartItems && cartData.cartItems.length > 0) {
                    cartItems = cartData.cartItems;
                    loadProductDetails();
                } else {
                    // Redirect to cart page if cart is empty
                    showError("Your cart is empty");
                    setTimeout(() => {
                        window.location.href = 'cart.html';
                    }, 2000);
                }
            },
            error: function(xhr) {
                console.error("Error loading cart data:", xhr);
                showError("Failed to load cart data");
            }
        });
    }

    // Load product details for cart items
    function loadProductDetails() {
        const token = localStorage.getItem('token');
        let productPromises = [];

        cartItems.forEach(item => {
            const promise = $.ajax({
                url: `${API_BASE_URL}/api/v1/product/${item.productId}`,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            }).then(product => {
                products[product.id] = product;
            });

            productPromises.push(promise);
        });

        Promise.all(productPromises)
            .then(() => {
                updateOrderSummary();
            })
            .catch(error => {
                console.error("Error loading product details:", error);
                showError("Failed to load product details");
            });
    }

    // Update order summary
    function updateOrderSummary() {
        const orderItemsContainer = $('#orderItems');
        orderItemsContainer.empty();

        cartTotal.subtotal = 0;

        cartItems.forEach(item => {
            const product = products[item.productId];

            if (product) {
                const itemTotal = product.price * item.quantity;
                cartTotal.subtotal += itemTotal;

                orderItemsContainer.append(`
                        <div class="order-item">
                            <span>${product.name} x ${item.quantity}</span>
                            <span>$${itemTotal.toFixed(2)}</span>
                        </div>
                    `);
            }
        });

        // Calculate tax and total
        cartTotal.tax = cartTotal.subtotal * 0.1; // 10% tax
        cartTotal.total = cartTotal.subtotal + cartTotal.shipping + cartTotal.tax;

        // Update summary amounts
        $('#subtotal').text(`$${cartTotal.subtotal.toFixed(2)}`);
        $('#shipping').text(`$${cartTotal.shipping.toFixed(2)}`);
        $('#tax').text(`$${cartTotal.tax.toFixed(2)}`);
        $('#total').text(`$${cartTotal.total.toFixed(2)}`);

        // Also update the review order section
        updateReviewOrder();
    }

    // Load saved addresses
    function loadSavedAddresses() {
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId') || 1;

        if (!token) return;

        $.ajax({
            url: `${API_BASE_URL}/api/addresses/user/${userId}`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(response) {
                const addresses = response.data || response;
                if (addresses && addresses.length > 0) {
                    displaySavedAddresses(addresses);
                } else {
                    // No saved addresses found
                    console.log("No saved addresses found for user");
                }
            },
            error: function(xhr) {
                console.error("Error loading saved addresses:", xhr);
            }
        });
    }

    // Display saved addresses
    function displaySavedAddresses(addresses) {
        const shippingAddressesContainer = $('#savedShippingAddresses');
        const billingAddressesContainer = $('#savedBillingAddresses');

        shippingAddressesContainer.empty();

        // Filter addresses by type
        const shippingAddresses = addresses.filter(a => a.addressType === 'SHIPPING' || !a.addressType);
        const billingAddresses = addresses.filter(a => a.addressType === 'BILLING');

        if (shippingAddresses.length > 0) {
            shippingAddressesContainer.append('<h5>Your Saved Addresses</h5>');

            // Find default address if any
            const defaultAddress = shippingAddresses.find(a => a.isDefault);

            shippingAddresses.forEach(address => {
                const isDefault = address.id === (defaultAddress ? defaultAddress.id : null);

                const addressCard = `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input saved-address-radio" type="radio" name="shippingAddressRadio"
                                id="address${address.id}" data-address-id="${address.id}" ${isDefault ? 'checked' : ''}>
                            <label class="form-check-label" for="address${address.id}">
                                <strong>${address.fullName}</strong>
                                ${isDefault ? '<span class="badge bg-primary ms-2">Default</span>' : ''}
                                <br>
                                ${address.addressLine1},
                                ${address.addressLine2 ? address.addressLine2 + ', ' : ''}
                                ${address.city}, ${address.state} ${address.postalCode}<br>
                                ${address.country}<br>
                                Phone: ${address.phoneNumber}
                            </label>
                        </div>
                    </div>
                </div>
            `;

                shippingAddressesContainer.append(addressCard);
            });

            // Add an option for new address
            shippingAddressesContainer.append(`
            <div class="card mb-2">
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input saved-address-radio" type="radio" name="shippingAddressRadio"
                            id="newShippingAddress" ${!defaultAddress ? 'checked' : ''}>
                        <label class="form-check-label" for="newShippingAddress">
                            <strong>Use a new address</strong>
                        </label>
                    </div>
                </div>
            </div>
        `);

            // Initially hide or show the form based on selection
            if (defaultAddress) {
                $('#shippingAddressForm').hide();
            } else {
                $('#shippingAddressForm').show();
            }

            // Add event handler for address selection
            $('.saved-address-radio').change(function() {
                if ($(this).attr('id') === 'newShippingAddress') {
                    $('#shippingAddressForm').slideDown(300);
                } else {
                    $('#shippingAddressForm').slideUp(300);

                    // Pre-fill billing address if same as shipping is checked
                    if ($('#sameAsShipping').is(':checked')) {
                        const addressId = $(this).data('address-id');
                        fillBillingAddressFromSaved(addressId, addresses);
                    }
                }
            });

            // Also populate billing address options if needed
            populateBillingAddresses(billingAddresses);
        }
    }

    // Helper function to populate billing addresses
    function populateBillingAddresses(billingAddresses) {
        if (!billingAddresses || billingAddresses.length === 0) return;

        const billingAddressesContainer = $('#savedBillingAddresses');
        billingAddressesContainer.empty();

        billingAddressesContainer.append('<h5>Your Saved Billing Addresses</h5>');

        // Find default billing address if any
        const defaultAddress = billingAddresses.find(a => a.isDefault);

        billingAddresses.forEach(address => {
            const isDefault = address.id === (defaultAddress ? defaultAddress.id : null);

            const addressCard = `
            <div class="card mb-2">
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="billingAddressRadio"
                            id="billingAddress${address.id}" data-address-id="${address.id}"
                            ${isDefault ? 'checked' : ''}>
                        <label class="form-check-label" for="billingAddress${address.id}">
                            <strong>${address.fullName}</strong>
                            ${isDefault ? '<span class="badge bg-primary ms-2">Default</span>' : ''}
                            <br>
                            ${address.addressLine1},
                            ${address.addressLine2 ? address.addressLine2 + ', ' : ''}
                            ${address.city}, ${address.state} ${address.postalCode}<br>
                            ${address.country}<br>
                            Phone: ${address.phoneNumber}
                        </label>
                    </div>
                </div>
            </div>
        `;

            billingAddressesContainer.append(addressCard);
        });
    }

    // Helper function to fill billing address from a saved address
    function fillBillingAddressFromSaved(addressId, addresses) {
        const selectedAddress = addresses.find(addr => addr.id == addressId);
        if (selectedAddress) {
            $('#billingFullName').val(selectedAddress.fullName);
            $('#billingPhone').val(selectedAddress.phoneNumber);
            $('#billingAddress1').val(selectedAddress.addressLine1);
            $('#billingAddress2').val(selectedAddress.addressLine2 || '');
            $('#billingCity').val(selectedAddress.city);
            $('#billingState').val(selectedAddress.state);
            $('#billingPostalCode').val(selectedAddress.postalCode);
            $('#billingCountry').val(selectedAddress.country);
        }
    }

    // Set up event handlers
    function setupEventHandlers() {
        // Checkout steps navigation
        $('#shippingNextBtn').click(function() {
            if (validateShippingAddress()) {
                navigateToStep(2);
            }
        });

        $('#billingBackBtn').click(function() {
            navigateToStep(1);
        });

        $('#billingNextBtn').click(function() {
            if (validateBillingAddress()) {
                navigateToStep(3);
            }
        });

        $('#paymentBackBtn').click(function() {
            navigateToStep(2);
        });

        $('#paymentNextBtn').click(function() {
            if (validatePaymentMethod()) {
                navigateToStep(4);
                updateReviewOrder();
            }
        });

        $('#reviewBackBtn').click(function() {
            navigateToStep(3);
        });

        // Same as shipping checkbox
        $('#sameAsShipping').change(function() {
            if ($(this).is(':checked')) {
                $('#billingAddressForm').hide();
            } else {
                $('#billingAddressForm').show();
            }
        });

        // Payment method selection
        $('.payment-method').click(function() {
            $('.payment-method').removeClass('selected');
            $(this).addClass('selected');

            selectedPaymentMethod = $(this).data('method');

            // Show/hide appropriate payment form
            $('#creditCardForm, #paypalForm, #cashForm').hide();
            $(`#${selectedPaymentMethod}Form`).show();
        });

        // Place order button
        $('#placeOrderBtn').click(function() {
            placeOrder();
        });
    }

    // Navigate to a specific checkout step
    function navigateToStep(stepNumber) {
        // Update step indicators
        $('.step').removeClass('active completed');
        $(`.step-${stepNumber}`).addClass('active');

        for (let i = 1; i < stepNumber; i++) {
            $(`.step-${i}`).addClass('completed');
        }

        // Hide all step content and show the current one
        $('.step-content').removeClass('active');
        $(`.step-${stepNumber}-content`).addClass('active');
    }

    // Validate shipping address form
    function validateShippingAddress() {
        // Check if using a saved address
        if ($('input[name="shippingAddressRadio"]:checked').attr('id') !== 'newShippingAddress') {
            return true;
        }

        // Validate form fields
        const requiredFields = [
            'shippingFullName', 'shippingPhone', 'shippingAddress1',
            'shippingCity', 'shippingState', 'shippingPostalCode', 'shippingCountry'
        ];

        for (const field of requiredFields) {
            if (!$(`#${field}`).val()) {
                showError(`Please enter your ${field.replace('shipping', '').toLowerCase()}`);
                return false;
            }
        }

        return true;
    }


    // Validate billing address form
    function validateBillingAddress() {
        // If same as shipping, no need to validate billing form
        if ($('#sameAsShipping').is(':checked')) {
            return true;
        }

        // Otherwise, validate billing form fields (similar to shipping validation)
        // Skipping implementation for brevity

        return true;
    }

    // Validate payment method
    function validatePaymentMethod() {
        if (selectedPaymentMethod === 'credit-card') {
            // Validate credit card form
            const cardNumber = $('#cardNumber').val();
            const cardName = $('#cardName').val();
            const cardExpiry = $('#cardExpiry').val();
            const cardCvv = $('#cardCvv').val();

            if (!cardNumber || !cardName || !cardExpiry || !cardCvv) {
                showError('Please fill in all card details');
                return false;
            }

            // Basic validation for card fields
            if (!/^\d{16}$/.test(cardNumber.replace(/\s/g, ''))) {
                showError('Please enter a valid card number');
                return false;
            }

            if (!/^\d{3,4}$/.test(cardCvv)) {
                showError('Please enter a valid CVV');
                return false;
            }
        }

        return true;
    }

    // Update review order section
    function updateReviewOrder() {
        // Set shipping address
        let shippingAddress = '';
        if ($('input[name="shippingAddressRadio"]:checked').attr('id') === 'newShippingAddress') {
            shippingAddress = `
                    ${$('#shippingFullName').val()}<br>
                    ${$('#shippingAddress1').val()},
                    ${$('#shippingAddress2').val() ? $('#shippingAddress2').val() + ', ' : ''}
                    ${$('#shippingCity').val()}, ${$('#shippingState').val()} ${$('#shippingPostalCode').val()}<br>
                    ${$('#shippingCountry').val()}
                `;
        } else {
            // Get selected saved address
            const addressId = $('input[name="shippingAddressRadio"]:checked').data('address-id');
            const addressLabel = $(`label[for="address${addressId}"]`).html();
            shippingAddress = addressLabel;
        }

        $('#reviewShippingAddress').html(shippingAddress);

        // Set billing address
        if ($('#sameAsShipping').is(':checked')) {
            $('#reviewBillingAddress').html(shippingAddress);
        } else {
            // Similar to shipping address logic
            $('#reviewBillingAddress').html('Same as shipping address');
        }

        // Set payment method
        let paymentMethodText = '';
        switch (selectedPaymentMethod) {
            case 'credit-card':
                paymentMethodText = `Credit Card (ending in ${$('#cardNumber').val().slice(-4)})`;
                break;
            case 'paypal':
                paymentMethodText = 'PayPal';
                break;
            case 'cash':
                paymentMethodText = 'Cash on Delivery';
                break;
        }

        $('#reviewPaymentMethod').text(paymentMethodText);

        // Set order items
        const reviewOrderItems = $('#reviewOrderItems');
        reviewOrderItems.empty();

        cartItems.forEach(item => {
            const product = products[item.productId];

            if (product) {
                reviewOrderItems.append(`
                        <div class="d-flex justify-content-between mb-2">
                            <div>
                                <strong>${product.name}</strong> x ${item.quantity}
                            </div>
                            <div>$${(product.price * item.quantity).toFixed(2)}</div>
                        </div>
                    `);
            }
        });

        // Add totals
        reviewOrderItems.append(`
                <hr>
                <div class="d-flex justify-content-between">
                    <strong>Subtotal:</strong>
                    <span>$${cartTotal.subtotal.toFixed(2)}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <strong>Shipping:</strong>
                    <span>$${cartTotal.shipping.toFixed(2)}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <strong>Tax:</strong>
                    <span>$${cartTotal.tax.toFixed(2)}</span>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <strong>Total:</strong>
                    <span>$${cartTotal.total.toFixed(2)}</span>
                </div>
            `);
    }

    // Place order
    function placeOrder() {
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId') || 1;

        if (!token) return;

        // Disable place order button
        $('#placeOrderBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Processing...');

        // Collect address information for the order
        let shippingAddress = {};
        let billingAddress = {};

        // Get shipping address (either saved or new)
        const useNewShippingAddress = $('#newShippingAddress').is(':checked');

        if (useNewShippingAddress) {
            shippingAddress = {
                userId: userId,
                fullName: $('#shippingFullName').val(),
                phoneNumber: $('#shippingPhone').val(),
                addressLine1: $('#shippingAddress1').val(),
                addressLine2: $('#shippingAddress2').val(),
                city: $('#shippingCity').val(),
                state: $('#shippingState').val(),
                postalCode: $('#shippingPostalCode').val(),
                country: $('#shippingCountry').val(),
                addressType: 'SHIPPING',
                isDefault: $('#saveShippingAddress').is(':checked')
            };
        } else {
            const selectedAddressId = $('input[name="shippingAddressRadio"]:checked').data('address-id');
            shippingAddress = { id: selectedAddressId };
        }

        // Get billing address if different from shipping
        const sameAsBilling = $('#sameAsShipping').is(':checked');
        if (sameAsBilling) {
            billingAddress = { ...shippingAddress, addressType: 'BILLING' };
        } else {
            billingAddress = {
                userId: userId,
                fullName: $('#billingFullName').val(),
                phoneNumber: $('#billingPhone').val(),
                addressLine1: $('#billingAddress1').val(),
                addressLine2: $('#billingAddress2').val(),
                city: $('#billingCity').val(),
                state: $('#billingState').val(),
                postalCode: $('#billingPostalCode').val(),
                country: $('#billingCountry').val(),
                addressType: 'BILLING',
                isDefault: false
            };
        }

        // Prepare order data
        const orderData = {
            userId: userId,
            shippingAddress: shippingAddress,
            billingAddress: billingAddress,
            paymentMethod: {
                type: selectedPaymentMethod,
                cardNumber: selectedPaymentMethod === 'credit-card' ? $('#cardNumber').val() : null,
                cardHolderName: selectedPaymentMethod === 'credit-card' ? $('#cardName').val() : null,
                expiryMonth: selectedPaymentMethod === 'credit-card' ? $('#cardExpiry').val().split('/')[0] : null,
                expiryYear: selectedPaymentMethod === 'credit-card' ? $('#cardExpiry').val().split('/')[1] : null
            }
        };

        // Send request to create order
        $.ajax({
            url: `${API_BASE_URL}/api/orders/place/${userId}`,
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(orderData),
            success: function(orderResponse) {
                const orderData = orderResponse.data || orderResponse;

                // Order placed successfully, now clear the cart
                clearCartAfterOrder(userId, token, orderData.id);
            },
            error: function(xhr) {
                console.error("Error placing order:", xhr);
                showError("Failed to place order. Please try again.");

                // Re-enable place order button
                $('#placeOrderBtn').prop('disabled', false).html('Place Order');
            }
        });
    }

    // Show success message
    function showSuccess(message) {
        $("#successMessage").text(message);
        $("#alertSuccess").addClass("show");
        setTimeout(() => $("#alertSuccess").removeClass("show"), 3000);
    }

    // Show error message
    function showError(message) {
        $("#errorMessage").text(message);
        $("#alertError").addClass("show");
        setTimeout(() => $("#alertError").removeClass("show"), 3000);
    }

    // Function to clear cart after successful order
    function clearCartAfterOrder(userId, token, orderId) {
        $.ajax({
            url: `${API_BASE_URL}/api/cart/${userId}/clear`,
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function() {
                showSuccess("Order placed successfully!");

                // Redirect to order confirmation page
                setTimeout(() => {
                    window.location.href = `order-confirmation.html?id=${orderId}`;
                }, 1500);
            },
            error: function(xhr) {
                console.error("Error clearing cart:", xhr);
                // Still redirect to order confirmation even if cart clear fails
                showSuccess("Order placed successfully!");
                setTimeout(() => {
                    window.location.href = `order-confirmation.html?id=${orderId}`;
                }, 1500);
            }
        });
    }

    // Function to set up the user dropdown toggle
    function setupUserDropdown() {
        $('.user-dropdown').click(function(e) {
            e.stopPropagation();
            $(this).find('.user-dropdown-menu').toggleClass('show');
        });

        $(document).click(function() {
            $('.user-dropdown-menu').removeClass('show');
        });

        $('#logoutBtn').click(function(e) {
            e.preventDefault();
            logout();
        });
    }

    // Function to check login status and update UI accordingly
    function checkLoginStatus() {
        const token = localStorage.getItem('token');
        const userEmail = localStorage.getItem('userEmail');
        const userRole = localStorage.getItem('role');

        if (token && userEmail) {
            // User is logged in
            $('#authButtons').addClass('d-none');
            $('#userDropdown').removeClass('d-none');
            $('#userNameDisplay').text(userEmail);

            // Add admin dashboard link if admin
            if (userRole === 'Admin') {
                $('.user-dropdown-menu').prepend(`
                <a href="admin-dashboard.html" class="user-dropdown-item">
                    <i class="fas fa-tachometer-alt me-2"></i> Admin Dashboard
                </a>
            `);
            }

            // Get cart count
            loadCartCount();
        } else {
            // User is not logged in
            $('#authButtons').removeClass('d-none');
            $('#userDropdown').addClass('d-none');
        }
    }

    // Function to load cart count
    function loadCartCount() {
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId') || 1;

        if (token) {
            $.ajax({
                url: `${API_BASE_URL}/api/cart/${userId}`,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function(data) {
                    let itemCount = 0;
                    if (data && data.cartItems) {
                        itemCount = data.cartItems.length;
                    }
                    $('#cartCount').text(itemCount);
                },
                error: function(xhr) {
                    console.error('Error loading cart:', xhr);
                }
            });
        }
    }

    // Function to handle logout
    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('userEmail');
        localStorage.removeItem('role');
        localStorage.removeItem('userId');
        window.location.href = 'index.html';
    }

    // Initialize header functionality on page load
    $(document).ready(function() {
        checkLoginStatus();
        setupUserDropdown();
    });

</script>
</body>
</html>